<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Mapa</title>

    <!-- Font awesome -->
    <script src="https://kit.fontawesome.com/f9fea94404.js"></script>

    <!-- Materialize -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
        integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
        crossorigin=""></script>

    <!-- Clustering -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css
" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css
" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- Leaflet Markers -->
    <link rel="stylesheet" href="markers/css/leaflet.extra-markers.min.css">
    <script src="markers/js/leaflet.extra-markers.min.js"></script>

    <!-- Jquery -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
        integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>

    <!-- Star ratnig -->
    <script src="star-rating.js"></script>
    <link rel="stylesheet" type="text/css" href="star-rating.css">

    <!-- Custom styles -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="fc_search.css" />
    <link rel="stylesheet" href="school_view.css" />
</head>

<body>
    <div id="map" style="width:100vw; height: 100vh"></div>

    <!-- Searchbar -->
    <div class="fs_container">
        <div class="wyszukiwarka">
            <img src="images/logo_search.png" class="search-logo" />
            <div class="text-field">
                <input id="searchbar" class="browser-default" type="text"
                    placeholder="Jaka jest najlepsza szkoła licealna we Wrocławiu?">
                <button id="search_btn"><i class="material-icons">search</i></button>
            </div>
        </div>
    </div>

    <!-- Buttons -->
    <div class="fixed-action-btn">
        <a class="btn-floating btn-large red">
            <i class="large material-icons">map</i>
        </a>
        <ul>
            <li><a id="enable_transport" class="btn-floating grey"><i class="material-icons">directions_bus</i></a></li>
            <li><a id="enable_cycling" class="btn-floating grey darken-1"><i
                        class="material-icons">directions_bike</i></a></li>
            <!--li><a class="btn-floating green"><i class="material-icons">public</i></a></li-->
        </ul>
    </div>

    <!-- School view -->
    <ul id="school_view" class="modal">
        <nav>
            <div class="container">
                <div class="nav-wrapper">
                    <img class="logo" src="images/logo_white.png" alt="">
                    <ul id="nav-mobile" class="right hide-on-med-and-down" style="margin-left:auto;">
                        <li><a href="#!" class="modal-close">X</a></li>
                    </ul>
                </div>
            </div>

        </nav>
        <div class="container">
            <h3 id="szkola-nazwa" class="school-name">Liceum ogólnokształcące nr. 3</h3>
            <div class="school-rating"></div>
            <div class="row">
                <div class="col s6">
                    <ul class="collection">
                        <li class="collection-item avatar">
                            <i class="material-icons circle">map</i>
                            <span class="title">Lokalizacja</span>
                            <p id="szkola_adres">
                            </p>
                        </li>
                        <li class="collection-item avatar">
                            <i class="material-icons circle">contact_phone</i>
                            <span class="title">Dane kontaktowe</span>
                            <p id="szkola_kontakt"></p>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="row">
                <div class="col s4">
                    <p class="desc">Profil szkoły</p>
                    <div class="chart-container" style="position: relative">
                        <canvas id="wykres_matury"></canvas>
                    </div>
                </div>
                <div class="col s4">
                    <p class="desc">Koedukacyjność</p>
                    <div class="chart-container" style="position: relative">
                        <canvas id="wykres_koedukacja"></canvas>
                    </div>
                </div>
                <div class="col s4">
                    <p class="desc">Na tle miasta</p>
                    <div class="chart-container" style="position: relative">
                        <canvas id="wykres_wyniki_matur"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!--
        <li><a href="#!"><i class="material-icons">cloud</i>First Link With Icon</a></li>
        <li><a href="#!">Second Link</a></li>
        <li>
            <div class="divider"></div>
        </li>
        <li><a class="subheader">Subheader</a></li>
        <li><a class="waves-effect" href="#!">Third Link With Waves</a></li>-->
    </ul>

    <div class="hidden">
        <div id="popup">
            69%
        </div>

    </div>
</body>

<script>

</script>

<script>
    // Materialize stuff
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.fixed-action-btn');
        var instances = M.FloatingActionButton.init(elems, {});
    });
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.sidenav');
        var instances = M.Sidenav.init(elems, {});
    });
    document.addEventListener('DOMContentLoaded', function () {
        var elems = document.querySelectorAll('.modal');
        var instances = M.Modal.init(elems, {});
    });


    // Star rating
    $(".school-rating").starRating({
        starSize: 30,
        initialRating: 0,
        callback: function (currentRating, $el) {
            // make a server call here
        }
    });

    // CONFIG CONTSANTS
    var TEXT_PROCESS_SERVER = "/process_text"

    // View layer buttons
    var transport_button = document.getElementById("enable_transport");
    var cycling_button = document.getElementById("enable_cycling");

    // Map layers
    var base_layer = L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });
    var transport_layer = L.tileLayer("http://www.openptmap.org/tiles/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });
    var cycling_layer = L.tileLayer("https://tile.waymarkedtrails.org/cycling/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    // Global state
    var transport_enabled = false;
    var cycling_enabled = false;

    var map = L.map('map').setView([51.1202707, 17.0271432,], 15);
    base_layer.addTo(map);

    // Show current location
    var has_location = false
    navigator.geolocation.getCurrentPosition((position) => {
        try {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;

            var home_icon = L.ExtraMarkers.icon({
                icon: 'fa-home',
                markerColor: 'violet',
                shape: 'penta',
                prefix: 'fa'
            });

            L.marker([latitude, longitude], { icon: home_icon }).addTo(map);

            map.panTo([latitude, longitude]);
        } catch (error) {
            has_location = false;
        }
    });

    // Map state buttons
    transport_button.addEventListener("click", () => {
        if (!transport_enabled) {
            transport_layer.addTo(map);
            transport_button.classList.remove("grey");
            transport_button.classList.add("green");
            transport_enabled = true;
        } else {
            map.removeLayer(transport_layer);
            transport_button.classList.remove("green");
            transport_button.classList.add("grey");
            transport_enabled = false;
        }
    });
    cycling_button.addEventListener("click", () => {
        if (!cycling_enabled) {
            cycling_layer.addTo(map);
            cycling_button.classList.remove("grey");
            cycling_button.classList.add("yellow");
            cycling_enabled = true;
        } else {
            map.removeLayer(cycling_layer);
            cycling_button.classList.remove("yellow");
            cycling_button.classList.add("grey");
            cycling_enabled = false;
        }
    });

    // Seeding markers
    // var marker = L.marker([51.1202707, 17.0271432])


    // Showing school screen
    var profile_chart = null;
    var coeducation_chart = null;
    var comparison_chart = null;
    showSchool = (school_info) => {
        console.log(school_info);
        //M.Modal.getInstance($('.modal').get(0)).open();
        M.Modal.getInstance($('#school_view').get(0)).open();

        // adress
        let adress_ln1 = "ul. " + school_info['Ulica'] + " " + school_info['NrDomu']
        let adress_ln2 = school_info["KodPocztowy"] + " " + school_info['Miejscowosc'];
        $('#szkola_adres').html(adress_ln1 + "<br/>" + adress_ln2);

        // contacct info
        let phone = school_info['Telefon'];
        let www = school_info['WWW'];
        let mail = school_info['Email'];
        $('#szkola_kontakt').html(phone + "<br/>" + mail + "<br/>" + www);

        $.get("/database_api/getFullInfo?rspo=" + school_info['RSPO'], (result) => {
            result = JSON.parse(result)
            console.log(result)

            $('#szkola-nazwa').html(result[0][0]['Nazwa']);

            if (result.length > 1 && result[1].length > 0) {
                polski = result[1][3]['SrWynik'];
                matematyka = result[1][4]['SrWynik'];
                angielski = result[1][5]['SrWynik'];
                chemia = result[1][7]['SrWynik'];
                fizyka = result[1][8]['SrWynik'];
                informatyka = result[1][11]['SrWynik'];

                if (coeducation_chart != null) {
                    coeducation_chart.destroy();
                    coeducation_chart = null;
                }
                if (comparison_chart != null) {
                    comparison_chart.destroy();
                    comparison_chart = null;
                }
                if (profile_chart != null) {
                    profile_chart.destroy();
                    profile_chart = null;
                }

                // Wykres wyników z matury
                dane_maturalne = {
                    labels: ['Polski', 'Matematyka', 'Angielski', 'Chemia', 'Fizyka', 'Informatyka'],
                    datasets: [{
                        data: [polski, matematyka, angielski, chemia, fizyka, informatyka],
                        label: "Profil szkoły",
                        backgroundColor: "rgba(52, 152, 219,0.5)",
                        borderColor: "rgba(52, 152, 219,1.0"
                    }]
                }
                profile_chart = new Chart($("#wykres_matury"), {
                    type: 'radar',
                    data: dane_maturalne,
                    options: {
                        legend: {
                            display: false
                        }
                    }
                });
            }

            dziewczyny = result[0][0]['LDziewczat']
            chlopaki = result[0][0]['LUczniow'] - dziewczyny

            if (chlopaki > 0 || dziewczyny > 0) {
                // Wykres koedukacyjny
                koedukacja = {
                    datasets: [{
                        data: [chlopaki, dziewczyny],
                        backgroundColor: [
                            "#0984e3",
                            "#fd79a8"
                        ],
                    }],

                    // These labels appear in the legend and in the tooltips when hovering different arcs
                    labels: [
                        'Chłopaki',
                        'Dziewczyny',
                    ]
                };
                coeducation_chart = new Chart($("#wykres_koedukacja"), {
                    type: 'doughnut',
                    data: koedukacja,
                    options: {}
                });
            }
        });

        $.get("database_api/getSimilarSchools?dist=10&rspo=" + school_info['RSPO'], (result) => {
            result = JSON.parse(result);
            console.log(result);

            szkola_1_nazwa = result[0]['Nazwa']
            szkola_2_nazwa = result[1]['Nazwa']
            szkola_3_nazwa = result[2][0]['Nazwa']
            szkola_4_nazwa = result[3]['Nazwa']
            szkola_5_nazwa = result[4]['Nazwa']

            szkola_1_wartosc = result[0]['Sr']
            szkola_2_wartosc = result[1]['Sr']
            szkola_3_wartosc = result[2][0]['Sr']
            szkola_4_wartosc = result[3]['Sr']
            szkola_5_wartosc = result[4]['Sr']

            wyniki_matur = {
                labels: [szkola_1_nazwa, szkola_2_nazwa, szkola_3_nazwa, szkola_4_nazwa, szkola_5_nazwa],
                datasets: [{
                    data: [szkola_1_wartosc, szkola_2_wartosc, szkola_3_wartosc, szkola_4_wartosc, szkola_5_wartosc],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)'
                    ],
                    borderWidth: 1
                }]
            }
            comparison_chart = new Chart($("#wykres_wyniki_matur"), {
                type: 'bar',
                data: wyniki_matur,
                options: {
                    legend: {
                        display: false
                    }
                }
            });
        })

        // Ocena szkoły
        let rating = school_info['RSPO'] % 6;
        $(".school-rating").starRating('setRating', rating);
    };
    //marker.addTo(map).bindPopup($("#popup").html());

    // Seraching 
    star_icon = (number) => L.ExtraMarkers.icon({
        icon: 'fa-number',
        markerColor: 'orange-dark',
        shape: 'star',
        number: number,
        prefix: 'fa'
    });
    normal_icon = (number) => L.ExtraMarkers.icon({
        icon: 'fa-number',
        markerColor: 'blue',
        shape: 'circle',
        number: number,
        prefix: 'fa'
    });

    actual_markers = null;
    actual_best_markers = null;

    $("#search_btn").click(() => {
        var value = $("#searchbar").val();
        var url = TEXT_PROCESS_SERVER + "?text=" + encodeURIComponent(value)

        $.get(url, (resp) => {
            resp = JSON.parse(resp);
            let is_sorted = resp.sorted;

            query = "/database_api/get_schools?limit=800";

            console.log(resp);

            if (resp.city!="") {
                query += "&city=" + resp.city;
            }
            if (resp.for_disabled) {
                query += "&for_disabled=1";
            }
            if (resp.sorted) {
                query += "&sorted=1"

                if (resp.criteria == "") {
                    resp.criteria = "matematyka"
                }
            } else {
                query += "&sorted=0";
            }
            if (resp.criteria != "") {
                query += "&sortby=" + resp.criteria;
            }

            console.log(query);

            if (resp.city != "") {
                $.get(query, (resp) => {
                    resp = JSON.parse(resp)
                    var mid_latitude = 0;
                    var mid_longitude = 0;
                    var markers = L.markerClusterGroup();
                    var best_markers = L.layerGroup();

                    for (i = 0; i < resp.length; i++) {
                        let school = resp[i]
                        latitude = school.LatitudeN;
                        longitude = school.LongitudeE;

                        if (latitude != null && longitude != null) {

                            if (is_sorted) {
                                if (i < 3) {
                                    marker = L.marker([latitude, longitude], { icon: star_icon(i + 1) })
                                    marker.on("click", () => showSchool(school))
                                    best_markers.addLayer(marker);
                                } else {
                                    marker = L.marker([latitude, longitude], { icon: normal_icon(i + 1) })
                                    marker.on("click", () => showSchool(school))
                                    markers.addLayer(marker);
                                }
                            } else {
                                marker = L.marker([latitude, longitude])
                                marker.on("click", () => showSchool(school))
                                markers.addLayer(marker);
                            }

                            mid_latitude += latitude / resp.length;
                            mid_longitude += longitude / resp.length;
                        }
                    }

                    if (actual_markers != null) {
                        map.removeLayer(actual_markers);
                        delete actual_markers;
                        actual_markers = null;
                    }

                    if (actual_best_markers != null) {
                        map.removeLayer(actual_best_markers);
                        delete actual_best_markers;
                        actual_best_markers = null;
                    }

                    map.addLayer(markers);
                    map.addLayer(best_markers);

                    actual_markers = markers;
                    actual_best_markers = best_markers;

                    map.panTo([mid_latitude, mid_longitude]);
                });
            }
        });
    });
</script>

</html>